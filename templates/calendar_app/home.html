{% extends 'calendar_app/base.html' %}

{% block content %}
<div class="calendar-container">
    <div class="header-section">
        <h1 class="main-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–∏—Ç–∞–Ω–∏—è</h1>
        {% if user.is_admin or user.is_superuser or user.is_staff %}
        <div class="upload-controls">
            <button class="btn btn-secondary" onclick="document.getElementById('menu-file').click()">
                <i class="fas fa-file"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
            </button>
            <span class="file-status">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            <input type="file" id="menu-file" style="display: none;" accept=".xlsx,.xls">
            <div class="parser-select">
                <label>
                    <input type="radio" name="parser_type" value="standard" checked> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
                </label>
                <label>
                    <input type="radio" name="parser_type" value="smart"> –£–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
                </label>
            </div>
            <button class="btn btn-primary" onclick="uploadFile()" id="upload-btn" disabled>
                <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é
            </button>
            <form method="post" action="{% url 'clear_calendar' %}" class="d-inline" onsubmit="return confirm('–í–ù–ò–ú–ê–ù–ò–ï! –ü—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –º–µ–Ω—é –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ –±–ª—é–¥–∞ –∏ –≤—ã–±–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm" title="–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">
                    <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å –º–µ–Ω—é
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <div class="user-info">
        <i class="fas fa-user"></i> –í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>{{ user.username }}</strong>
    </div>

    <h2 class="week-title">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</h2>
    <div class="week-grid">
        {% for day_menu in current_week_menu %}
        <div class="day-card">
            <h3>{{ day_menu.date|date:"l, j E Y"|default_if_none:"" }}</h3>
            <div class="selected-dishes">
                {% if day_menu.user_selection %}
                    {% if day_menu.user_selection.selected_salad %}
                        <div class="dish-row">ü•ó –°–∞–ª–∞—Ç ‚Äî {{ day_menu.user_selection.selected_salad.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_soup %}
                        <div class="dish-row">ü•£ –°—É–ø ‚Äî {{ day_menu.user_selection.selected_soup.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_main %}
                        <div class="dish-row">üçñ –û—Å–Ω–æ–≤–Ω–æ–µ ‚Äî {{ day_menu.user_selection.selected_main.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_side %}
                        <div class="dish-row">ü•î –ì–∞—Ä–Ω–∏—Ä ‚Äî {{ day_menu.user_selection.selected_side.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_bakery %}
                        <div class="dish-row">ü•® –í—ã–ø–µ—á–∫–∞ ‚Äî {{ day_menu.user_selection.selected_bakery.name }}</div>
                    {% endif %}
                {% else %}
                    <div class="dish-row empty">‚ùå –ë–ª—é–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="no-menu">
            <p>–ù–µ—Ç –º–µ–Ω—é –Ω–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é</p>
        </div>
        {% endfor %}
    </div>

    <h2 class="week-title">–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è</h2>
    <div class="week-grid">
        {% for day_menu in next_week_menu %}
        <div class="day-card">
            <h3>{{ day_menu.date|date:"l, d F Y" }}</h3>
            <div class="meal-select">
                <a href="{% url 'day_detail' day_menu.id %}" class="btn btn-primary">
                    <i class="fas fa-utensils"></i> –í—ã–±—Ä–∞—Ç—å –±–ª—é–¥–∞
                </a>
            </div>
            <div class="selected-dishes">
                {% if day_menu.user_selection %}
                    {% if day_menu.user_selection.selected_salad %}
                        <div class="dish-row">ü•ó –°–∞–ª–∞—Ç ‚Äî {{ day_menu.user_selection.selected_salad.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_soup %}
                        <div class="dish-row">ü•£ –°—É–ø ‚Äî {{ day_menu.user_selection.selected_soup.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_main %}
                        <div class="dish-row">üçñ –û—Å–Ω–æ–≤–Ω–æ–µ ‚Äî {{ day_menu.user_selection.selected_main.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_side %}
                        <div class="dish-row">ü•î –ì–∞—Ä–Ω–∏—Ä ‚Äî {{ day_menu.user_selection.selected_side.name }}</div>
                    {% endif %}
                    {% if day_menu.user_selection.selected_bakery %}
                        <div class="dish-row">ü•® –í—ã–ø–µ—á–∫–∞ ‚Äî {{ day_menu.user_selection.selected_bakery.name }}</div>
                    {% endif %}
                {% else %}
                    <div class="dish-row empty">‚ùå –ë–ª—é–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="no-menu">
            <p>–ù–µ—Ç –º–µ–Ω—é –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é</p>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.calendar-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.main-title {
    color: #1a237e;
    font-size: 24px;
    margin: 0;
}

.upload-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-status {
    color: #666;
    margin: 0 10px;
}

.user-info {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    color: #1976d2;
}

.week-title {
    color: #1a237e;
    margin: 30px 0 20px;
    font-size: 20px;
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.day-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.day-card h3 {
    color: #1976d2;
    margin: 0 0 15px;
    font-size: 18px;
}

.meal-select {
    margin: 15px 0;
}

.selected-dishes {
    margin-top: 10px;
    font-size: 14px;
    line-height: 1.5;
}

.dish-row {
    padding: 3px 0;
    color: #333;
}

.dish-row.empty {
    color: #888;
    font-style: italic;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-sm {
    padding: 6px 10px;
    font-size: 12px;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
    transform: translateY(-1px);
}

.btn:hover {
    opacity: 0.9;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.parser-select {
    margin: 0 10px;
    display: flex;
    gap: 15px;
}

.parser-select label {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #666;
    cursor: pointer;
}

.parser-select input[type="radio"] {
    cursor: pointer;
}

@media (max-width: 768px) {
    .header-section {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }

    .upload-controls {
        flex-direction: column;
    }

    .file-status {
        text-align: center;
        margin: 10px 0;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }

    .parser-select {
        flex-direction: column;
        align-items: flex-start;
        margin: 10px 0;
    }
}
</style>

<script>
document.getElementById('menu-file').addEventListener('change', function(e) {
    var fileName = e.target.files[0] ? e.target.files[0].name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
    document.querySelector('.file-status').textContent = fileName;
    document.getElementById('upload-btn').disabled = !e.target.files[0];
});

function uploadFile() {
    var fileInput = document.getElementById('menu-file');
    var file = fileInput.files[0];
    if (!file) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
        return;
    }

    var formData = new FormData();
    formData.append('excel_file', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –ø–∞—Ä—Å–µ—Ä–∞
    var parserType = document.querySelector('input[name="parser_type"]:checked').value;
    formData.append('parser_type', parserType);

    var uploadBtn = document.getElementById('upload-btn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        return response.text().then(text => {
            try {
                return JSON.parse(text);
            } catch (e) {
                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.reload();
                return null;
            }
        });
    })
    .then(data => {
        if (data && data.status === 'success') {
            location.reload();
        } else if (data && data.message) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + data.message);
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ–Ω–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    })
    .finally(() => {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é';
    });
}

function confirmClear() {
    return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');
}
</script>
{% endblock %} 